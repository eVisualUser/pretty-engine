#ifndef H_SERIAL
#define H_SERIAL

#include <PrettyEngine/PrettyError.hpp>
#include <PrettyEngine/debug/debug.hpp>

#include <sstream>
#include <toml++/toml.hpp>
#include <Guid.hpp>

#include <string>

namespace PrettyEngine {
	#define SERIAL_TOKEN(token) #token
	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
	enum class SerializationFormat {
		Toml,
	};

	class SerializedField {
	  public:
		SerializedField(std::string newType, std::string newName, std::string newValue) { 
			this->type = std::move(newType);
			this->name = std::move(newName);
			this->value = std::move(newValue);
		}

		SerializedField() = default;

		std::string type;
		std::string name;
		std::string value;
	};

	class PropertyEventListenner {
	public:
		virtual void OnSetupProperties() {};
	};

 	/// Serialized object
	class SerialObject {
	public:
		virtual ~SerialObject() = default;

		virtual void AddToToml(toml::table* table) { DebugLog(LOG_DEBUG, "To do", false); }
		virtual void FromToml(toml::table* table) { DebugLog(LOG_DEBUG, "To do", false); }

		void SetObjectSerializedName(std::string newName) {
			this->serialObjectName = std::move(newName);
		}

		void SetupSerial(std::string newObjectName, std::string newUnique) {
			this->SetSerializedUnique(std::move(newUnique));
			this->SetObjectSerializedName(std::move(newObjectName));
		}

		std::string GetObjectSerializedName() { return this->serialObjectName; }
		std::string GetObjectSerializedUnique() { return this->serialObjectUnique; }

		void SetSerializedUnique(std::string newUnique) {
			this->serialObjectUnique = newUnique;
		}

		void AddSerializedField(SerializedField serializedField) {

			if (!this->ContainSerializedField(serializedField.name)) {
				this->serialFields.push_back(serializedField);
			}
		}

		/// Reduce memory current use.
		void OptimizeSerialization() { 
			for (auto &serialField : this->serialFields) {
				serialField.name.shrink_to_fit();
				serialField.type.shrink_to_fit();
				serialField.value.shrink_to_fit();
			}

			this->serialObjectName.shrink_to_fit();
			this->serialObjectUnique.shrink_to_fit();

			this->serialFields.shrink_to_fit();
		}

		void AddSerializedField(std::string newType, std::string newName, std::string newValue) { 
			SerializedField serializedField(newType, newName, newValue);
			return this->AddSerializedField(serializedField);
		}

		SerializedField* GetSerializedField(std::string name) { 
			for (auto &field : this->serialFields) {
				if (field.name == name) {
					return &field;
				}
			}
			return nullptr;
		}

		std::string GetSerializedFieldValue(std::string name) {
			if (this->ContainSerializedField(name)) {
				for (auto &serial : this->serialFields) {
					if (serial.name == name) {
						return serial.value;
					} 
				}
			}
			return "";
		}

		std::string GetSerilizedFiledType(std::string name) {
			if (this->ContainSerializedField(name)) {
				for (auto &serial : this->serialFields) {
					if (serial.name == name) {
						return serial.type;
					}
				}
			}
			return "";
		}

		bool ContainSerializedField(std::string name) {
			for (auto &serializedField : this->serialFields) {
				if (name == serializedField.name) {
					return true;
				}
			}

			return false;
		}

		std::string Serialize(SerializationFormat serialFormat = SerializationFormat::Toml) {
			if (serialFormat == SerializationFormat::Toml) {
				auto out = toml::parse("");

				out.insert_or_assign("ObjectName", this->serialObjectName);

				if (this->serialObjectUnique.empty()) {
					this->serialObjectUnique = xg::newGuid();
				}

				out.insert_or_assign("ObjectUnique", this->serialObjectUnique);

				auto fieldTable = toml::table();
				for(auto & field: this->serialFields) {
					auto valueArray = toml::array();
					valueArray.push_back(field.type);
					valueArray.push_back(field.value);

					fieldTable.insert_or_assign(field.name, valueArray);
				}

				out.insert_or_assign("fields", fieldTable);

				std::stringstream result;
				result << out;
				return result.str();
			}
		
			return "";
		}

		void Deserialize(std::string input, SerializationFormat serialFormat = SerializationFormat::Toml) {
			if (!input.empty() && serialFormat == SerializationFormat::Toml) {
				auto out = toml::parse(input);

				this->serialObjectName = out["ObjectName"].value_or("Null");
				this->serialObjectUnique = out["ObjectUnique"].value_or("Null");

				if (this->serialObjectUnique.empty()) {
					this->serialObjectUnique = xg::newGuid();
				}

				auto fields = out["fields"].as_table();
				if (fields != nullptr) {
					for(auto & field: *fields) {
						if (field.second.is_array()) {
							int index = 0;
							auto fieldArray = field.second.as_array();
							SerializedField serializedField;
							serializedField.name = field.first;
							for (auto & element: *fieldArray) {
								auto value = element.value_or("null");

								if (index == 0) {
									serializedField.type = value;
								} else if (index == 1) {
									serializedField.value = value;
								}

								index++;
							}
							this->serialFields.push_back(serializedField);
						}
					}
				}
			}
		}
	public:
		std::string serialObjectName;
		std::string serialObjectUnique;
		std::vector<SerializedField> serialFields;

		std::vector<PropertyEventListenner*> propertyEventListennerList;
	};

	template<typename T>
	class PublicProperty: public PropertyEventListenner {
	public:
		PublicProperty(SerialObject* newContainer, const std::string& typeName, const std::string& newName, const T& newValue, std::function<std::string(T)> newSerializeFunction, std::function<T(std::string)> newDeserializeFunction) {
			this->Initialize(newContainer, typeName, newName, newValue, newSerializeFunction, newDeserializeFunction);
		}

		~PublicProperty() {
			this->_container.HaveValue([this](SerialObject* value) {
				auto propertyEventListennerList = &value->propertyEventListennerList;
				for(int i = 0; i < propertyEventListennerList->size(); i++) {
					if ((*propertyEventListennerList)[i] == this) {
						propertyEventListennerList->erase(propertyEventListennerList->begin() + i);
						break;
					}
				}
			});
		}

		void OnSetupProperties() override {
			this->_container.HaveValue([this](SerialObject* value) {
				value->AddSerializedField(this->_typeName, this->_name, (this->_serializeFunction)(this->_value));
			});

			this->DeserializeValue();
		}

		void Initialize(SerialObject* newContainer, const std::string& typeName, const std::string& newName, const T& newValue, std::function<std::string(T)> newSerializeFunction, std::function<T(std::string)> newDeserializeFunction) {
			newContainer->propertyEventListennerList.push_back(this);

			this->_name = newName;

			this->_value = newValue;

			this->_serializeFunction = newSerializeFunction;
			this->_deserializeFunction = newDeserializeFunction;

			this->_container = newContainer;

			this->_typeName = typeName;
		}

		void DeserializeValue() {
			this->_container.HaveValue([this](SerialObject* value) {
				this->_value = this->_deserializeFunction(value->GetSerializedFieldValue(this->_name));
			});
		}

		void SerializeValue() {
			this->_container.HaveValue([this](SerialObject* value) {
				if (auto serialiedField = value->GetSerializedField(this->_name)) {
					serialiedField->value = this->_serializeFunction(value->GetSerializedField(this->_name)->value);
				}
			});
		}

		void Save() {
			this->_container.HaveValue([this](SerialObject* value) {
				value->GetSerializedField(this->_name)->value = (this->_serializeFunction)(this->_value);
			});
		}

		T* Get() {
			return &this->_value;
		}

	private:
		std::function<std::string(const T&)> _serializeFunction;
		std::function<T(const std::string&)> _deserializeFunction;

		Option<SerialObject*> _container = Option<SerialObject*>(nullptr);

		std::string _name;
		std::string _typeName;

		T _value;
	};
}

#endif